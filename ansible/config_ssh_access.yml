- hosts: director
  gather_facts: false
  user: stack
  tasks:
    - name: 'Create awx user on director'
      user:
        name: awx
        password: $6$omu6IQS6.C6jcJqV$7ktgP/5F6eaUr2hFIWK52R1NNIV/RnqEogGCt7jRuVSfqePqHV5rA6IchnLVSg7atcODxvfQzOtcuBkPoCXUA1
        state: present
        generate_ssh_key: yes
        ssh_key_bits: 4096
        ssh_key_comment: Generated by AWX/Ansible Tower Automation
      become: true

    - name: "Add awx user's public key to authorized_keys file"
      ansible.posix.authorized_key:
        user: 'awx'
        state: present
        key: '{{ lookup("file","../keys/awx_ssh.pub") }}'
        comment: key from awx_ssh credential in AWX
      become: true

    - name: Create temporary directory on director
      ansible.builtin.tempfile:
        state: directory
        prefix: user_config
      register: tempdir

    - name: Copy required files to the director
      copy:
        src: '{{ item }}'
        dest: '{{ tempdir.path }}'
      loop:
        - user_config.yml
        - ../keys/awx_ssh.pub
    - name: Copy required files to /home/awx
      copy:
        src: '/home/stack/{{ item }}'
        dest: '/home/awx/{{ item | regex_replace(".*/","") }}'
        remote_src: true
        owner: awx
        group: awx
      become: true
      loop:
        - stackrc
        - '{{ awx_inventory_name }}/undercloud/instackenv.json'
    - name: Run user_config.yaml on the director
      shell: 'ansible-playbook -i /home/stack/ansible/inventory.yaml user_config.yml -e keyfile=awx_ssh.pub'
      args:
        chdir: '{{ tempdir.path }}'
      ignore_errors: True
      register: user_config_result

    - name: Delete temporary on director
      file:
        state: absent
        path: '{{ tempdir.path }}'

    - name: Check user_config.yaml playbook was successful
      assert:
        that: user_config_result.rc == 0
        fail_msg: '{{ user_config_result.stdout_lines }}'
